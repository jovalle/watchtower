services:
  watchtower:
    build:
      context: .
      dockerfile: Dockerfile
    cap_drop:
      - ALL
    container_name: watchtower
    environment:
      # Required
      PLEX_TOKEN: ${PLEX_TOKEN:?PLEX_TOKEN is required}
      SESSION_SECRET: ${SESSION_SECRET:-local-dev-secret-change-in-production}
      # Server config (defaults work for local Docker with Plex container)
      PLEX_SERVER_URL: ${PLEX_SERVER_URL:-http://plex:32400}
      PLEX_CLIENT_ID: ${PLEX_CLIENT_ID:-watchtower-001}
      PORT: ${WATCHTOWER_PORT:-9001}
      NODE_ENV: production
      # Cookie security: false for LAN/HTTP, true for HTTPS (see .env.example)
      SECURE_COOKIES: ${SECURE_COOKIES:-false}
      # Optional integrations (leave empty to disable)
      OMDB_API_KEY: ${OMDB_API_KEY:-}
      TMDB_API_KEY: ${TMDB_API_KEY:-}
      TRAKT_CLIENT_ID: ${TRAKT_CLIENT_ID:-}
    healthcheck:
      interval: 30s
      retries: 3
      start_period: 10s
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:9001/",
        ]
      timeout: 3s
    image: watchtower:local
    pull_policy: never
    ports:
      - "${WATCHTOWER_PORT:-9001}:9001"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: 1001:1001
    volumes:
      - ./data:/data
